!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.KeratinAuthN={})}(this,function(e){"use strict";function t(e){return Object.keys(e).map(function(t){return n(t,e[t])}).filter(function(e){return void 0!==e}).join("&")}function n(e,t){if(void 0!==t)return e+"="+encodeURIComponent(t)}function o(e,n){return s(function(o){o.open("GET",(e+"?"+t(n)).replace(/\?$/,"")),o.send()})}function r(e){return s(function(t){t.open("DELETE",e),t.send()})}function i(e,n){return s(function(o){o.open("POST",e),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(t(n))})}function s(e){return new Promise(function(t,n){var o=new XMLHttpRequest;o.withCredentials=!0,o.onreadystatechange=function(){if(o.readyState==XMLHttpRequest.DONE){var e=o.responseText.length>1?JSON.parse(o.responseText):{};e.result?t(e.result):e.errors?n(e.errors):o.status>=200&&o.status<400?t():n([{message:""===o.statusText?"connection failed":o.statusText}])}},e(o)})}function u(e){return new Promise(function(t,n){v?n([{message:"duplicate"}]):(v=!0,i(l("/accounts"),e).then(function(e){return t(e.id_token)},function(e){return n(e)}).then(function(){return v=!1}))})}function c(e){return"username"===e.field&&"TAKEN"===e.message}function a(){return o(l("/session/refresh"),{}).then(function(e){return e.id_token})}function f(e){return i(l("/session"),e).then(function(e){return e.id_token})}function h(){return r(l("/session"))}function p(e){return i(l("/password"),e).then(function(e){return e.id_token})}function d(e){return i(l("/password"),e).then(function(e){return e.id_token})}function l(e){if(!g.length)throw"ISSUER not set";return""+g+e}function m(e){try{return JSON.parse(atob(e.split(".")[1]))}catch(e){throw"Malformed JWT: invalid encoding"}}function w(){var e="keratin-authn-test";try{return window.localStorage.setItem(e,e),window.localStorage.removeItem(e),!0}catch(e){return!1}}function y(e){I.setStore(e)}var v=!1,g="",S=function(){function e(e){this.token=e,this.claims=m(e)}return e.prototype.iat=function(){return 1e3*this.claims.iat},e.prototype.exp=function(){return 1e3*this.claims.exp},e.prototype.halflife=function(){return(this.exp()-this.iat())/2},e}(),T=function(){function e(){var e=this;document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&e.scheduleRefresh()})}return e.prototype.setStore=function(e){this.store=e},e.prototype.sessionToken=function(){if(this.store)return this.store.read()},e.prototype.update=function(e){if(this.store){this.store.update(e);var t=new S(e);this.refreshAt=Date.now()+t.halflife(),this.scheduleRefresh()}},e.prototype.endSession=function(){this.refreshAt=void 0,this.timeoutID&&clearTimeout(this.timeoutID),this.store&&this.store.delete()},e.prototype.restoreSession=function(){var e=this;return new Promise(function(t,n){if(e.store){var o=e.sessionToken();if(o){var r=Date.now(),i=new S(o),s=i.iat()+i.halflife();if(isNaN(s))return e.store.delete(),void n("Malformed JWT: can not calculate refreshAt");r>=s||r<i.iat()?e.refresh().then(t,n):(e.refreshAt=s,e.scheduleRefresh(),t())}else n("No session.")}else n("No session storage available.")})},e.prototype.refresh=function(){var e=this;return a().then(function(t){return e.update(t)},function(t){throw t[0]&&"Unauthorized"===t[0].message&&e.endSession(),t})},e.prototype.scheduleRefresh=function(){var e=this;this.timeoutID&&clearTimeout(this.timeoutID),this.refreshAt&&(this.timeoutID=setTimeout(function(){return e.refresh()},this.refreshAt-Date.now()))},e}(),N=function(){function e(e,t){this.sessionName=e,this.sessionPath="; path="+t+";",this.secureFlag="https:"===window.location.protocol?"; secure":""}return e.prototype.read=function(){return document.cookie.replace(new RegExp("(?:(?:^|.*;\\s*)"+this.sessionName+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1")},e.prototype.update=function(e){document.cookie=this.sessionName+"="+e+this.secureFlag+this.sessionPath},e.prototype.delete=function(){document.cookie=this.sessionName+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT"+this.sessionPath},e}(),k=function(){function e(){}return e.prototype.read=function(){return this.session},e.prototype.update=function(e){this.session=e},e.prototype.delete=function(){this.session=void 0},e}(),x=function(){function e(e){this.sessionName=e}return e.prototype.read=function(){return window.localStorage.getItem(this.sessionName)||void 0},e.prototype.update=function(e){window.localStorage.setItem(this.sessionName,e)},e.prototype.delete=function(){window.localStorage.removeItem(this.sessionName)},e}(),I=new T;e.restoreSession=function(){return I.restoreSession()},e.importSession=function(){return I.refresh()},e.setCookieStore=function(e,t){y(new N(e,t))},e.setLocalStorageStore=function(e){y(w()?new x(e):new k)},e.session=function(){return I.sessionToken()},e.signup=function(e){return u(e).then(function(e){return I.update(e)})},e.login=function(e){return f(e).then(function(e){return I.update(e)})},e.logout=function(){return h().then(function(){return I.endSession()})},e.changePassword=function(e){return p(e).then(function(e){return I.update(e)})},e.resetPassword=function(e){return d(e).then(function(e){return I.update(e)})},e.setHost=function(e){g=e.replace(/\/$/,"")},e.isAvailable=function(e){return o(l("/accounts/available"),{username:e}).then(function(e){return e}).catch(function(e){if(!(e instanceof Error)&&e.some(c))return!1;throw e})},e.requestPasswordReset=function(e){return o(l("/password/reset"),{username:e})},Object.defineProperty(e,"__esModule",{value:!0})});
